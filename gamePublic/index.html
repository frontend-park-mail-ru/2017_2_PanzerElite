<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <title>Cube</title>
    <style>
        body {
            text-align: center;
        }
        
        canvas {
            color: white;
            width: 100%;
            height: 100%;
            border: 1px solid white;
        }
    </style>
</head>

<body>
    <h1>Liquid Three.js Cube</h1>
    <p>Change the browser's window size.</p>
    <script src="three.min.js"></script>
    <script src="TrackballControls.js"></script>
    <script src="./collada.js"></script>
    <script src="./keyboard-min.js"></script>
    <!-- Get the latest version of the Three.js library. -->
    <script>
        class Tank {
            constructor(dae, x, y, z) {
                this.dae = new THREE.Object3D();
                this.parent = new THREE.Object3D();
                this.parent.position.x = -1;
                this.parent.position.z = +4.4;
                this.dae.add(this.parent);
                this.original = null;
                this.angle = Math.PI - Math.PI;
                ////new motion
                this.forward = false;
                this.backward = false;
                this.right = false;
                this.left = false;
                this.turret = null;
                this.turretRight = false;
                this.turretLeft = false;
                ////collisions try
                this.BB = null;
                ////bullettry
                this.bullet = null;
                this.fire = false;
            }
            moveForward() {
                this.dae.position.y += 0.3 * Math.cos(this.angle);
                this.dae.position.x += 0.3 * Math.sin(this.angle);
                this.turret.dae.position.y += 0.3 * Math.cos(this.angle);
                this.turret.dae.position.x += 0.3 * Math.sin(this.angle);
                this.bullet.position.y += 0.3 * Math.cos(this.angle);
                this.bullet.position.x += 0.3 * Math.sin(this.angle);
            }
            moveBackward() {
                this.dae.position.y -= 0.2 * Math.cos(this.angle);
                this.dae.position.x -= 0.2 * Math.sin(this.angle);
                this.turret.dae.position.y -= 0.2 * Math.cos(this.angle);
                this.turret.dae.position.x -= 0.2 * Math.sin(this.angle);
                this.bullet.position.y -= 0.3 * Math.cos(this.angle);
                this.bullet.position.x -= 0.3 * Math.sin(this.angle);
            }
            turnRight() {
                this.dae.rotation.y += 0.005 * Math.PI;
                this.angle += 0.005 * Math.PI;
            }
            turnLeft() {
                this.dae.rotation.y -= 0.005 * Math.PI;
                this.angle -= 0.005 * Math.PI;
            }
            turnTurretRight() {
                this.turret.dae.rotation.y += 0.008 * Math.PI;
                this.bullet.rotation.z += 0.008 * Math.PI;
            }
            turnTurretLeft() {
                this.turret.dae.rotation.y -= 0.008 * Math.PI;
                this.bullet.rotation.z -= 0.008 * Math.PI;
            }
            Fire() {
                this.bullet.position.y += 1 * Math.cos(this.angle);
                this.bullet.position.x += 1 * Math.sin(this.angle);
            }
            update(col) {
                //collision
                if (this.original != null) {
                    this.BB.setFromObject(this.original);
                }
                //new motion
                if (this.forward) {
                    this.moveForward();
                    if (this.BB.intersectsBox(col)) {
                        this.moveBackward();
                        this.moveBackward();
                    }
                }
                if (this.backward) {
                    this.moveBackward();
                    if (this.BB.intersectsBox(col)) {
                        this.moveForward();
                        this.moveForward();
                    }
                }
                if (this.right) {
                    this.turnRight();
                    if (this.BB.intersectsBox(col)) {
                        this.turnLeft();
                        this.turnLeft();
                    }
                }
                if (this.left) {
                    this.turnLeft();
                    if (this.BB.intersectsBox(col)) {
                        this.turnRight();
                        this.turnRight();
                    }
                }
                if (this.turretLeft) {
                    this.turnTurretLeft();
                }
                if (this.turretRight) {
                    this.turnTurretRight();
                }
                if (this.fire) {
                    this.Fire();
                }
            }
        };
        class Turret {
            constructor(dae, x, y, z) {
                this.dae = new THREE.Object3D();
                this.parent = new THREE.Object3D();
                this.parent.position.x = -0.33;
                this.parent.position.z = -2;
                this.parent.position.y = +1.7;
                this.parent.rotation.y += Math.PI;
                this.dae.add(this.parent);
                this.angle = Math.PI - Math.PI;
            }
        };
        //////
        var scene,
            camera,
            renderer,
            controls;

        scene = new THREE.Scene();

        var dae, loader = new THREE.ColladaLoader();
        var tank = new Tank(null, 0, 0, 0);
        var turret = new Turret(null, 0, 0, 0);

        //var secondBB = new THREE.Box3();
        tank.BB = new THREE.Box3();

        function loadCollada(collada) {
            collada.scene.children[0].children[1].children[0].children[3] = new THREE.Object3D();
            tank.parent.add(collada.scene);
            tank.original = collada.scene;
            //secondBB.setFromObject(tank.original);
            tank.dae.rotation.x = -0.5 * Math.PI;
            tank.dae.rotation.z = 1 * Math.PI;
            scene.add(tank.dae);
            renderPhone();
        }
        loader.options.convertUpAxis = true;
        loader.load('model.dae', loadCollada);

        function loadCollada2(collada) {
            let size = 0.012;
            collada.scene.scale.x = size;
            collada.scene.scale.y = size;
            collada.scene.scale.z = size;
            turret.parent.add(collada.scene);
            turret.dae.rotation.x = -0.5 * Math.PI;
            turret.dae.rotation.z = 1 * Math.PI;
            scene.add(turret.dae);
            // renderPhone();
        }
        loader2 = new THREE.ColladaLoader();
        loader2.options.convertUpAxis = true;
        loader2.load('turret.dae', loadCollada2);

        ///
        tank.turret = turret;

        //var secondBB;
        let plc = new THREE.Object3D();
        var firstBB = new THREE.Box3();

        function loadCollada3(collada) {
            let size = 0.05;
            collada.scene.scale.x = size;
            collada.scene.scale.y = size;
            collada.scene.scale.z = size;
            //plc.position.set(new THREE.Vector3(0, 0, 0));

            plc.add(collada.scene);
            plc.rotation.x = -0.5 * Math.PI;
            plc.rotation.z = 1 * Math.PI;
            //console.log(plc);
            plc.position.x = 90;
            plc.position.y = 90;
            //scene.add(plc);
            var geometry = new THREE.BoxGeometry(1, 20, 4);
            var material = new THREE.MeshBasicMaterial({
                color: 0x00ff00
            });
            var cube = new THREE.Mesh(geometry, material);
            cube.position.x = 9;
            cube.position.y = 9;
            cube.position.z = 1.5;
            firstBB.setFromObject(cube);
            scene.add(cube);

        }
        loader3 = new THREE.ColladaLoader();
        loader3.options.convertUpAxis = true;
        loader3.load('tree-boom/model.dae', loadCollada3);


        let bullet = new THREE.Object3D();

        function loadCollada4(collada) {
            let size = 0.015;
            collada.scene.scale.x = size;
            collada.scene.scale.y = size;
            collada.scene.scale.z = size;
            //plc.position.set(new THREE.Vector3(0, 0, 0));

            bullet.add(collada.scene);
            bullet.rotation.x = -1 * Math.PI;
            bullet.rotation.z = 1 * Math.PI;
            //console.log(plc);
            bullet.position.x = 0.5;
            bullet.position.y = 0;
            bullet.position.z = 1.55;
            scene.add(bullet);
            tank.bullet = bullet;

        }
        loader4 = new THREE.ColladaLoader();
        loader4.options.convertUpAxis = true;
        loader4.load('bullet.dae', loadCollada4);

        /////


        ////Old Camera
        camera = new THREE.PerspectiveCamera(10, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(-1, 15, -115);

        camera.lookAt(new THREE.Vector3(tank.x - 1, tank.y + 3, 3));
        //camera.lookAt(tank.x - 1, tank.y - 4.4, tank.z + 3);
        renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: true
        });

        //tank.dae.add(camera);
        turret.dae.add(camera);

        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(
            renderer.domElement);
        ///////////////////////////////////////// // Trackball Controller ///////////////////////////////////////// 
        ///////////////////////////////////////// // Lighting ///////////////////////////////////////// 
        var iphone_color = '#FAFAFA',
            ambientLight = new THREE.AmbientLight('#EEEEEE'),
            hemiLight = new THREE.HemisphereLight(iphone_color, iphone_color, 0),
            light = new THREE.PointLight(iphone_color, 1, 100);
        hemiLight.position.set(0, 50, 0);
        light.position.set(0, 20, 10);
        scene.add(ambientLight);
        scene.add(hemiLight);
        scene.add(light);
        ///////////////////////////////////////// // Utilities ///////////////////////////////////////// 
        var axisHelper = new THREE.AxisHelper(10);
        scene.add(axisHelper);

        function renderPhone() {
            tank.update(firstBB);
            renderer.render(scene, camera);
        }

        keyboardJS.bind('m', function(e) {
            tank.turretRight = true;
        }, function(e) {
            tank.turretRight = false;
        });
        keyboardJS.bind('n', function(e) {
            tank.turretLeft = true;
        }, function(e) {
            tank.turretLeft = false;
        });
        keyboardJS.bind('w', function(e) {
            tank.forward = true;
        }, function(e) {
            tank.forward = false;
        });
        keyboardJS.bind('s', function(e) {
            tank.backward = true;
        }, function(e) {
            tank.backward = false;
        });
        keyboardJS.bind('d', function(e) {
            tank.right = true;
        }, function(e) {
            tank.right = false;
        });
        keyboardJS.bind('a', function(e) {
            tank.left = true;
        }, function(e) {
            tank.left = false;
        });
        ///
        keyboardJS.bind('f', function(e) {
            tank.fire = true;
        }, function(e) {
            tank.fire = false;
        });

        function animationLoop() {
            requestAnimationFrame(animationLoop);
            renderPhone();
            //controls.update();
        }
        animationLoop(); ///////////////////////////////////////// // Window Resizing ///////////////////////////////////////// 
        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            //controls.handleResize();
            renderPhone();
        }, false); ///////////////////////////////////////// // Object Loader /////////////////////////////////////////
    </script>
</body>

</html>